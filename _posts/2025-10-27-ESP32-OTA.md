---
layout: post
title: "ESP32 Secure Firmware Updates Over-the-Air with AWS S3"
date: 2025-10-27
categories: [ESP32, IoT, AWS]
tags: [ESP32, OTA, S3, firmware, embedded]
---

# ESP32 Secure Firmware Updates Over-the-Air with AWS S3

Updating firmware on deployed ESP32 devices can be challenging. In this tutorial, we'll build a secure OTA (Over-The-Air) update system using ESP32, AWS S3, and HTTPS.

## Why OTA Updates Matter

Imagine deploying 100 ESP32 devices across different locations. When you need to fix a bug or add features, physically accessing each device isn't practical. OTA updates let you:

- Deploy updates remotely to all devices
- Ensure security through HTTPS
- Roll back to previous versions if needed
- Track deployment status

## Architecture Overview
```
ESP32 Device  <---HTTPS--->  AWS S3 Bucket
    |                            |
    |-- 1. Check version         |
    |-- 2. Download firmware     |
    |-- 3. Flash & reboot        |
```

## What You'll Need

**Hardware:**
- ESP32 or ESP32-S3 board
- USB cable

**Software:**
- Arduino IDE or PlatformIO
- AWS Account
- These libraries: WiFi, HTTPClient, Update, WiFiClientSecure

## Step 1: Set Up AWS S3

1. Create an S3 bucket (e.g., `my-iot-firmware`)
2. Enable versioning for rollback capability
3. Create this structure:
```
my-iot-firmware/
├── latest/
│   ├── firmware.bin
│   └── version.json
```

4. Create `version.json`:
```json
{
  "version": "1.0.0",
  "build": 1,
  "url": "https://my-iot-firmware.s3.amazonaws.com/latest/firmware.bin",
  "size": 894960
}
```

5. Make the bucket publicly readable or use pre-signed URLs for production.

## Step 2: Get AWS Root Certificate

Download Amazon's root CA certificate - your ESP32 needs this for HTTPS:
```bash
curl -o AmazonRootCA1.pem https://www.amazontrust.com/repository/AmazonRootCA1.pem
```

## Step 3: ESP32 Code

Here's the complete OTA client:
```cpp
#include <WiFi.h>
#include <HTTPClient.h>
#include <Update.h>
#include <WiFiClientSecure.h>
#include <ArduinoJson.h>

// WiFi credentials
const char* ssid = "YOUR_SSID";
const char* password = "YOUR_PASSWORD";

// S3 URLs
const char* versionURL = "https://YOUR-BUCKET.s3.amazonaws.com/latest/version.json";
const char* firmwareURL = "https://YOUR-BUCKET.s3.amazonaws.com/latest/firmware.bin";

// Current version
#define FIRMWARE_VERSION "1.0.0"
#define FIRMWARE_BUILD 1

// AWS Root CA (paste the certificate content here)
const char* rootCA = \
"-----BEGIN CERTIFICATE-----\n" \
"MIIDQTCCAimgAwIBAgITBmyfz5m/jAo54vB4ikPmljZbyjANBgkqhkiG9w0BAQsF\n" \
// ... rest of certificate
"-----END CERTIFICATE-----\n";

void setup() {
  Serial.begin(115200);
  
  // Connect to WiFi
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi connected!");
  
  // Check for updates
  if (checkForUpdates()) {
    performOTA();
  }
}

void loop() {
  // Check every hour
  static unsigned long lastCheck = 0;
  if (millis() - lastCheck > 3600000) {
    lastCheck = millis();
    if (checkForUpdates()) {
      performOTA();
    }
  }
  delay(1000);
}

bool checkForUpdates() {
  WiFiClientSecure client;
  client.setCACert(rootCA);
  
  HTTPClient https;
  if (!https.begin(client, versionURL)) {
    Serial.println("Connection failed");
    return false;
  }
  
  int httpCode = https.GET();
  if (httpCode == HTTP_CODE_OK) {
    String payload = https.getString();
    
    JsonDocument doc;
    deserializeJson(doc, payload);
    
    int latestBuild = doc["build"];
    
    Serial.printf("Current: %d, Latest: %d\n", FIRMWARE_BUILD, latestBuild);
    
    https.end();
    return latestBuild > FIRMWARE_BUILD;
  }
  
  https.end();
  return false;
}

void performOTA() {
  WiFiClientSecure client;
  client.setCACert(rootCA);
  
  HTTPClient https;
  if (!https.begin(client, firmwareURL)) {
    Serial.println("Download failed");
    return;
  }
  
  int httpCode = https.GET();
  if (httpCode == HTTP_CODE_OK) {
    int contentLength = https.getSize();
    
    if (Update.begin(contentLength)) {
      Serial.println("Starting update...");
      
      WiFiClient * stream = https.getStreamPtr();
      size_t written = Update.writeStream(*stream);
      
      if (written == contentLength) {
        Serial.println("Update successful!");
      }
      
      if (Update.end()) {
        if (Update.isFinished()) {
          Serial.println("Rebooting...");
          delay(1000);
          ESP.restart();
        }
      } else {
        Serial.printf("Update error: %s\n", Update.errorString());
      }
    }
  }
  
  https.end();
}
```

## Step 4: Upload Your Firmware

1. Build your project in Arduino IDE or PlatformIO
2. Find the `firmware.bin` file in your build folder
3. Upload to S3:
```bash
aws s3 cp firmware.bin s3://my-iot-firmware/latest/
aws s3 cp version.json s3://my-iot-firmware/latest/
```

## Testing

1. Flash the initial firmware (v1.0.0) to your ESP32
2. Update the version in your code to v1.1.0
3. Build and upload the new firmware to S3
4. Update `version.json` with build number 2
5. Watch your ESP32 automatically update!

## Security Tips

For production use:
- Enable secure boot on ESP32
- Use device authentication with AWS IoT Core
- Implement firmware signing
- Use pre-signed S3 URLs instead of public access
- Add MD5 checksum verification

## Troubleshooting

**Update fails:** Check that your partition table includes OTA partitions and has enough space.

**Certificate errors:** Make sure you've copied the complete AWS root CA certificate including the BEGIN and END lines.

**Download timeout:** Increase timeout with `https.setTimeout(30000);`

## Next Steps

- Add a web dashboard to manage firmware versions
- Implement rollback capability
- Set up monitoring for update success rates
- Add support for delta updates to save bandwidth

## Complete Code

Find the complete working example on GitHub: [link to your repo]

---

That's it! You now have a working OTA update system for your ESP32 devices. Questions or improvements? Leave a comment below!
